FROM gradle:8.0.1-jdk17-jammy as build
ENV SERVICE_DIR=/usr/app
RUN mkdir -p $SERVICE_DIR
WORKDIR $SERVICE_DIR
ADD . $SERVICE_DIR
RUN gradle clean bootJar

FROM openjdk:17-jdk-alpine
COPY --from=build /usr/app/build/libs/LandscapeService*.jar /app/runner.jar

ENV SERVICE_PORT=8081

ENV RANCHER_GRPC_PORT=9093
ENV HANDYMAN_GRPC_PORT=9092

ENV RANCHER_GRPC_HOST=rancher-service
ENV HANDYMAN_GRPC_HOST=handyman-service

ENV POSTGRES_HOST=postgres
ENV POSTGRES_PORT=5432
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=postgres
ENV POSTGRES_NAME_DB=database

ENTRYPOINT java -jar /app/runner.jar \
--SERVICE_PORT=${SERVICE_PORT} \
--RANCHER_GRPC_PORT=${RANCHER_GRPC_PORT} \
--HANDYMAN_GRPC_PORT=${HANDYMAN_GRPC_PORT} \
--RANCHER_GRPC_HOST=${RANCHER_GRPC_HOST} \
--HANDYMAN_GRPC_HOST=${HANDYMAN_GRPC_HOST} \
--POSTGRES_HOST: ${POSTGRES_CONTAINER_NAME} \
--POSTGRES_PORT: ${POSTGRES_PORT} \
--POSTGRES_USER: ${POSTGRES_USER} \
--POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} \
--POSTGRES_NAME_DB: ${POSTGRES_NAME_DB}
